name: Build and Push to Harbor

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-beta"
      - "*.*.*"
      - "*.*.*-beta"

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_for_file: ${{ steps.version.outputs.version_for_file }}
      is_beta: ${{ steps.version.outputs.is_beta }}
      tag: ${{ steps.version.outputs.tag }}
      sharx_tag_version: ${{ steps.tags.outputs.sharx_tag_version }}
      sharx_tag_latest: ${{ steps.tags.outputs.sharx_tag_latest }}
      node_tag_version: ${{ steps.tags.outputs.node_tag_version }}
      node_tag_latest: ${{ steps.tags.outputs.node_tag_latest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          # Check if it's a beta tag
          if [[ "$VERSION" == *"-beta" ]]; then
            IS_BETA=true
            VERSION_WITHOUT_BETA=${VERSION%-beta}
            # For beta, keep the version as is (e.g., "1.0.0-beta")
            VERSION_FOR_FILE="$VERSION_WITHOUT_BETA"
          else
            IS_BETA=false
            VERSION_WITHOUT_BETA=$VERSION
            # For main, use clean version (e.g., "1.0.0")
            VERSION_FOR_FILE="$VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_without_beta=$VERSION_WITHOUT_BETA" >> $GITHUB_OUTPUT
          echo "version_for_file=$VERSION_FOR_FILE" >> $GITHUB_OUTPUT
          echo "is_beta=$IS_BETA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Version for file: $VERSION_FOR_FILE"
          echo "Is beta: $IS_BETA"

      - name: Update version file for build
        run: |
          echo "${{ steps.version.outputs.version_for_file }}" > config/version
          echo "Updated config/version to: ${{ steps.version.outputs.version_for_file }}"
          cat config/version

      - name: Update version in branch
        run: |
          # Determine branch from tag
          if [[ "${{ steps.version.outputs.is_beta }}" == "true" ]]; then
            BRANCH="beta"
          else
            BRANCH="main"
          fi
          
          echo "Updating version in branch: $BRANCH"
          
          # Checkout branch
          git fetch origin $BRANCH:$BRANCH || echo "Branch $BRANCH not found, skipping version update"
          git checkout $BRANCH 2>/dev/null || {
            echo "Could not checkout branch $BRANCH, version will be updated only for build"
            exit 0
          }
          
          # Update version file
          echo "${{ steps.version.outputs.version_for_file }}" > config/version
          
          # Commit if changed
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/version
          
          if git diff --staged --quiet; then
            echo "Version already up to date in branch $BRANCH"
          else
            git commit -m "chore: update version to ${{ steps.version.outputs.version_for_file }} [skip ci]"
            git push origin $BRANCH || echo "Failed to push to $BRANCH, but continuing..."
            echo "✅ Version updated in branch $BRANCH to ${{ steps.version.outputs.version_for_file }}"
          fi
          
          # Go back to tag for build
          git checkout ${{ github.ref }}

      - name: Determine image tags
        id: tags
        run: |
          HARBOR_HOST="${{ secrets.HARBOR_HOST }}"
          HARBOR_PROJECT="${{ secrets.HARBOR_PROJECT }}"
          VERSION="${{ steps.version.outputs.version }}"
          IS_BETA="${{ steps.version.outputs.is_beta }}"
          
          if [ "$IS_BETA" = "true" ]; then
            # For beta: push version with -beta suffix and latest-beta
            SHARX_TAG_VERSION="$HARBOR_HOST/$HARBOR_PROJECT/sharx:$VERSION"
            SHARX_TAG_LATEST="$HARBOR_HOST/$HARBOR_PROJECT/sharx:latest-beta"
            NODE_TAG_VERSION="$HARBOR_HOST/$HARBOR_PROJECT/node:$VERSION"
            NODE_TAG_LATEST="$HARBOR_HOST/$HARBOR_PROJECT/node:latest-beta"
          else
            # For main: push version and latest
            SHARX_TAG_VERSION="$HARBOR_HOST/$HARBOR_PROJECT/sharx:$VERSION"
            SHARX_TAG_LATEST="$HARBOR_HOST/$HARBOR_PROJECT/sharx:latest"
            NODE_TAG_VERSION="$HARBOR_HOST/$HARBOR_PROJECT/node:$VERSION"
            NODE_TAG_LATEST="$HARBOR_HOST/$HARBOR_PROJECT/node:latest"
          fi
          
          echo "sharx_tag_version=$SHARX_TAG_VERSION" >> $GITHUB_OUTPUT
          echo "sharx_tag_latest=$SHARX_TAG_LATEST" >> $GITHUB_OUTPUT
          echo "node_tag_version=$NODE_TAG_VERSION" >> $GITHUB_OUTPUT
          echo "node_tag_latest=$NODE_TAG_LATEST" >> $GITHUB_OUTPUT
          
          echo "SharX tags: $SHARX_TAG_VERSION, $SHARX_TAG_LATEST"
          echo "Node tags: $NODE_TAG_VERSION, $NODE_TAG_LATEST"

  build-sharx:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USER }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Update version file
        run: |
          echo "${{ needs.prepare.outputs.version_for_file }}" > config/version

      - name: Build and push sharx image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ needs.prepare.outputs.sharx_tag_version }}
            ${{ needs.prepare.outputs.sharx_tag_latest }}
          # Build only for amd64 by default for faster builds
          # Change to "linux/amd64,linux/arm64,linux/arm/v7" for multi-arch
          platforms: linux/amd64
          cache-from: |
            type=registry,ref=${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/sharx:buildcache
            type=gha
          cache-to: |
            type=registry,ref=${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/sharx:buildcache,mode=max
            type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  build-node:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USER }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build and push node image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./node/Dockerfile
          push: true
          tags: |
            ${{ needs.prepare.outputs.node_tag_version }}
            ${{ needs.prepare.outputs.node_tag_latest }}
          # Build only for amd64 by default for faster builds
          # Change to "linux/amd64,linux/arm64,linux/arm/v7" for multi-arch
          platforms: linux/amd64
          cache-from: |
            type=registry,ref=${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/node:buildcache
            type=gha
          cache-to: |
            type=registry,ref=${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/node:buildcache,mode=max
            type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  postgres:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USER }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Pull postgres image and push to Harbor
        run: |
          HARBOR_HOST="${{ secrets.HARBOR_HOST }}"
          HARBOR_PROJECT="${{ secrets.HARBOR_PROJECT }}"
          POSTGRES_VERSION="16-alpine"
          
          echo "Pulling postgres:$POSTGRES_VERSION..."
          docker pull postgres:$POSTGRES_VERSION
          
          echo "Tagging and pushing to Harbor..."
          docker tag postgres:$POSTGRES_VERSION $HARBOR_HOST/$HARBOR_PROJECT/postgres:$POSTGRES_VERSION
          docker tag postgres:$POSTGRES_VERSION $HARBOR_HOST/$HARBOR_PROJECT/postgres:latest
          docker push $HARBOR_HOST/$HARBOR_PROJECT/postgres:$POSTGRES_VERSION
          docker push $HARBOR_HOST/$HARBOR_PROJECT/postgres:latest
          
          echo "✅ Postgres image pushed successfully"

  release:
    needs: [prepare, build-sharx, build-node, postgres]
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body: |
            ## Release ${{ needs.prepare.outputs.tag }}
            
            ### Docker Images
            
            Images are available in Harbor:
            
            - **sharx**: `${{ needs.prepare.outputs.sharx_tag_version }}` / `${{ needs.prepare.outputs.sharx_tag_latest }}`
            - **node**: `${{ needs.prepare.outputs.node_tag_version }}` / `${{ needs.prepare.outputs.node_tag_latest }}`
            - **postgres**: ${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/postgres:16-alpine / ${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/postgres:latest
            
            ### Usage
            
            Update your `docker-compose.yml`:
            
            ```yaml
            services:
              sharx:
                image: ${{ needs.prepare.outputs.sharx_tag_latest }}
              node:
                image: ${{ needs.prepare.outputs.node_tag_latest }}
              postgres:
                image: ${{ secrets.HARBOR_HOST }}/${{ secrets.HARBOR_PROJECT }}/postgres:latest
            ```
            
            ### Changes
            
            See commit history for detailed changes.
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_beta == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
