# SharX

[English](README_EN.md) | [Русский](README_RU.md) | [فارسی](README_FA.md)

## Добро пожаловать в SharX

**SharX** — это форк оригинальной панели **3XUI** с расширенными возможностями и функциями мониторинга.

Эта версия приносит значительные улучшения, современную архитектуру, упрощенный процесс установки с использованием Docker-контейнеров и **интеграцию с Grafana** для продвинутого мониторинга с Prometheus и Loki.

## Список изменений

### Режим узлов (1 панель – несколько узлов)
- **Централизованное управление**: Одна панель теперь может управлять несколькими узлами
- **Режим регистрации**: При первом запуске узлы работают в режиме регистрации и ждут подключения от панели
- **Безопасная аутентификация**: Панель выдает API-токен, подписывает узел и сохраняет его для дальнейшего использования
- **Масштабируемая архитектура**: Легко добавлять или удалять узлы по мере роста инфраструктуры

### Разделение сущностей клиента и входящих подключений
- **Гибкое назначение клиентов**: Клиент теперь может быть назначен нескольким входящим подключениям
- **Подписки с несколькими входящими**: Все назначенные входящие подключения отображаются в подписке
- **Гибкость узлов**: Несколько узлов могут быть назначены одному входящему подключению
- **Лучшее управление ресурсами**: Более эффективное использование ресурсов сервера

### Вкладка хостов
- **Переопределение адресов**: Переопределение адресов узлов в подписках
- **Поддержка прокси**: Идеально для узлов, скрытых за прокси или балансировщиком нагрузки
- **Гибкая маршрутизация**: Настройка разных адресов хостов для разных случаев использования

### Интеграция Redis
- **Повышение производительности**: Значительно более быстрый отклик интерфейса
- **Умное кэширование**: Кэширование частых запросов к базе данных
- **Эффективная подача данных**: Если параметры запроса не изменились и кэш действителен, данные подаются напрямую из Redis
- **Снижение нагрузки на базу данных**: Меньше нагрузки на базу данных PostgreSQL

### Полная миграция на PostgreSQL
- **Надежная база данных**: Полная миграция с SQLite на PostgreSQL
- **Обновленный импорт/экспорт**: Раздел резервного копирования обновлен для PostgreSQL
- **Инструмент миграции**: Встроенный инструмент миграции с SQLite на PostgreSQL поддерживает существующих пользователей
- **Целостность данных**: Полная и надежная передача данных в процессе миграции

### Интеграция Grafana
- **Метрики Prometheus**: Сбор и мониторинг метрик в реальном времени
- **Логи Loki**: Централизованная агрегация и анализ логов
- **Продвинутый мониторинг**: Комплексные дашборды для мониторинга производительности системы
- **Оповещения**: Настраиваемые алерты на основе метрик и логов

### Новая модель распространения
- **На основе Docker**: Предварительно собранные Docker-образы для легкого развертывания
- **Кроссплатформенность**: Работает на любой ОС и архитектуре процессора
- **Быстрая установка**: Загрузка готовых образов за 5–10 секунд
- **Без компиляции**: Нет необходимости компилировать код на слабых серверах
- **Легкая миграция**: Простая миграция и масштабирование на основе контейнеров

### HWID устройств (Бета)
- **Идентификация устройств**: Идентификация устройств по уникальному идентификатору оборудования для повышения безопасности
- **Защита клиентов**: Защита от несанкционированного доступа и утечек подписок
- **Контроль устройств**: Ограничение и мониторинг того, какие устройства могут использовать подписку клиента
- **Индивидуальная настройка**: По умолчанию выключено, можно включать индивидуально для каждого клиента
- **Поддержка клиентов**: На данный момент поддерживается в клиентах Happ и V2RayTun
- **Защита от утечек**: Если подписка утекла, доступ к ней получат только зарегистрированные устройства
- **Мониторинг использования**: Отслеживание того, какие устройства используют каждый аккаунт
- **Гибкая безопасность**: Включайте защиту HWID только для клиентов, которым это необходимо

## Установка

### Требования
- Linux сервер (Ubuntu, Debian, CentOS, Fedora, Arch, Alpine, openSUSE)
- Root доступ
- Доступные порты: 2053 (веб-интерфейс), 2096 (подписки), 80 (для SSL сертификата)

---

## Вариант 1: Автоматическая установка (Рекомендуется)

### Установка 

Клонируйте и запустите:

```bash
git clone https://github.com/konstpic/3x-ui-new.git
cd 3x-ui-new
sudo ./install_ru.sh
```

### Что делает скрипт

Скрипт установки автоматически:
- Определяет ваш дистрибутив Linux
- Устанавливает Docker и Docker Compose
- Настраивает режим сети (host или bridge с пробросом портов)
- Настраивает SSL сертификаты через Let's Encrypt (acme.sh)
  - Для доменов: сертификаты на 90 дней с автопродлением
  - Для IP адресов: сертификаты на 6 дней с автопродлением
- Генерирует безопасный пароль базы данных
- Создаёт и запускает все сервисы

### Поддерживаемые системы

| Дистрибутив | Пакетный менеджер |
|-------------|-------------------|
| Ubuntu/Debian | apt |
| Fedora | dnf |
| CentOS/RHEL | yum |
| Arch Linux | pacman |
| Alpine | apk |
| openSUSE | zypper |

### Установка панели через скрипт

```bash
sudo ./install_ru.sh
```

Выберите **1) Install Panel** и следуйте подсказкам:
1. Выберите режим сети (host/bridge)
2. Установите порты панели и подписок
3. Сгенерируйте или введите пароль базы данных
4. Выберите тип SSL сертификата (домен/IP/пропустить)

### Установка узла через скрипт

```bash
sudo ./install_ru.sh
```

Выберите **2) Install Node** и следуйте подсказкам:
1. Выберите режим сети (host/bridge)
2. Установите API порт
3. Выберите тип SSL сертификата

### Меню управления

После установки запустите скрипт снова для доступа к меню управления:

```bash
sudo ./install_ru.sh
```

**Доступные опции:**
- **Панель**: Установка, Обновление, Запуск, Остановка, Перезапуск, Статус, Логи
- **Настройки панели**: Смена портов, Смена пароля БД, Обновление/Настройка сертификатов
- **Узел**: Установка, Обновление, Запуск, Остановка, Перезапуск, Статус, Логи, Обновление сертификатов
- **Удаление**

### Обновление панели/узла

```bash
sudo ./install_ru.sh
# Выберите: 2) Update Panel или 21) Update Node
```

Процесс обновления:
1. Скачивает новый Docker образ (пока сервис работает)
2. Останавливает и удаляет старый контейнер
3. Запускает новый контейнер с обновлённым образом
4. База данных НЕ перезапускается (данные не теряются)

---

## Вариант 2: Ручная установка

### Установка панели

1. **Клонируйте или загрузите этот репозиторий**
   ```bash
   git clone https://github.com/konstpic/3x-ui-new.git
   cd 3x-ui-new
   ```

2. **Настройте Docker Compose**
   
   Отредактируйте `docker-compose.yml` и обновите следующие настройки:
   
   **Настройка базы данных:**
   - Измените `change_this_password` на надежный пароль в `XUI_DB_PASSWORD` и `POSTGRES_PASSWORD`
   - Эти пароли должны совпадать, чтобы панель могла подключиться к PostgreSQL
   - Пример:
     ```yaml
     XUI_DB_PASSWORD: ваш_надежный_пароль
     POSTGRES_PASSWORD: ваш_надежный_пароль
     ```
   
   **Настройка портов:**
   - Порты по умолчанию: 2053 (веб-интерфейс), 2096 (подписки), 5432 (PostgreSQL)
   - При необходимости настройте проброс портов:
     ```yaml
     ports:
       - "2053:2053"   # Веб-интерфейс
       - "2096:2096"   # Подписки
       - "5432:5432"   # PostgreSQL (опционально, для внешнего доступа)
     ```
   
   **Имя хоста (опционально):**
   - Раскомментируйте и установите `hostname`, если хотите указать имя хоста для контейнера:
     ```yaml
     hostname: ваше_имя_хоста
     ```
   
   **Режим сети (опционально):**
   - Для лучшей производительности можно использовать сетевой режим хоста
   - Раскомментируйте `network_mode: host`:
     ```yaml
     network_mode: host
     ```
   - При использовании режима хоста удалите секцию `ports`, так как порты будут напрямую открыты на хосте

3. **Подготовьте SSL-сертификаты для TLS**
   
   **Важно**: Для TLS/HTTPS соединения необходимо:
   - Доменное имя, указывающее на ваш сервер
   - SSL-сертификаты (файл сертификата и приватный ключ)
   
   **Шаг 1: Создайте директорию для сертификатов**
   ```bash
   mkdir -p cert
   ```
   
   **Шаг 2: Скопируйте ваши SSL-сертификаты**
   
   Скопируйте файлы SSL-сертификатов в директорию `cert`. Вам понадобятся:
   - Файл сертификата (обычно `cert.pem` или `fullchain.pem`)
   - Файл приватного ключа (обычно `privkey.pem` или `key.pem`)
   
   Пример:
   ```bash
   # Скопируйте файл сертификата
   cp /путь/к/вашему/сертификату.pem cert/cert.pem
   
   # Скопируйте файл приватного ключа
   cp /путь/к/вашему/приватному_ключу.key cert/privkey.pem
   ```
   
   **Примечание**: Сертификаты будут смонтированы в `/root/cert/` внутри контейнера, но в настройках панели следует использовать пути `/app/cert/`.
   
   **Требования к сертификатам:**
   - Файл сертификата должен называться `cert.pem`
   - Файл приватного ключа должен называться `privkey.pem`
   - Оба файла должны находиться в директории `cert/`
   - Убедитесь в правильных правах доступа к файлам (читаемые контейнером)

4. **Запустите сервисы**
   ```bash
   docker-compose up -d
   ```

5. **Откройте веб-интерфейс**
   
   Откройте браузер и перейдите по адресу:
   ```
   http://ip-вашего-сервера:2053
   ```
   
   Или при использовании HTTPS:
   ```
   https://ip-вашего-сервера:2053
   ```

6. **Начальная настройка**
   - Пройдите мастер начальной настройки
   - Создайте учетную запись администратора
   - Настройте первое подключение узла

7. **Настройте TLS в настройках панели**
   
   После доступа к панели настройте TLS для безопасных соединений:
   
   **В настройках панели:**
   - Перейдите в Настройки/Конфигурация
   - **Доменное имя**: Введите ваше доменное имя (например, `panel.example.com`)
     - Это должно быть доменное имя, указывающее на ваш сервер
     - Домен должен иметь валидные DNS-записи, указывающие на IP-адрес вашего сервера
   
   **Пути к сертификатам:**
   - **Путь к сертификату**: `/app/cert/cert.pem`
     - Это путь внутри контейнера, где находится файл сертификата
     - Файл `cert.pem` должен находиться в директории `cert/` на хосте
   
   - **Путь к приватному ключу**: `/app/cert/privkey.pem`
     - Это путь внутри контейнера, где находится файл приватного ключа
     - Файл `privkey.pem` должен находиться в директории `cert/` на хосте
   
   **Важные примечания:**
   - Пути `/app/cert/` являются внутренними путями контейнера
   - Ваши фактические файлы находятся в директории `cert/` на хосте
   - Docker Compose монтирует `$PWD/cert/` в `/root/cert/` в контейнере
   - Панель использует пути `/app/cert/`, которые должны соответствовать вашим смонтированным сертификатам
   - Убедитесь, что оба файла `cert.pem` и `privkey.pem` существуют в вашей директории `cert/`
   
   **Проверка конфигурации TLS:**
   - После сохранения настроек перезапустите контейнер:
     ```bash
     docker-compose restart 3xui
     ```
   - Откройте панель через HTTPS: `https://ваш-домен.com:2053`
   - Проверьте, что браузер показывает валидный SSL-сертификат

### Установка узла

1. **Перейдите в директорию узла**
   ```bash
   cd node
   ```

2. **Настройте узел**
   
   Отредактируйте `docker-compose.yml` и настройте:
   - **Порты**: Установите подходящие порты для вашего узла
   - **Режим сети**: Выберите между мостовым или сетевым режимом хоста
   - **Конфигурация**: При необходимости настройте `bin/config.json`
   
   **SSL-сертификаты для узла (рекомендуется):**
   - Создайте директорию `cert` в папке узла:
     ```bash
     mkdir -p cert
     ```
   - Скопируйте ваши SSL-сертификаты:
     - **Файл сертификата**: `fullchain.pem` (рекомендуется для узлов)
     - **Файл приватного ключа**: `privkey.pem`
     ```bash
     cp /путь/к/fullchain.pem cert/fullchain.pem
     cp /путь/к/privkey.pem cert/privkey.pem
     ```
   - Сертификаты будут смонтированы в `/app/cert/` внутри контейнера
   - Переменные окружения в `docker-compose.yml` должны указывать на:
     - `NODE_TLS_CERT_FILE=/app/cert/fullchain.pem`
     - `NODE_TLS_KEY_FILE=/app/cert/privkey.pem`

3. **Запустите узел**
   ```bash
   docker-compose up -d
   ```

4. **Подключите к панели**
   - Узел запустится в режиме регистрации
   - В панели добавьте новый узел
   - Панель выдаст API-токен и подключится к узлу
   - Узел будет подписан и сохранен для дальнейшего использования

### Расширенная настройка

#### Использование сетевого режима хоста

Если вы хотите использовать сетевой режим хоста (рекомендуется для лучшей производительности), раскомментируйте строку `network_mode: host` в `docker-compose.yml`:

```yaml
network_mode: host
```

При использовании режима хоста удалите секцию `ports`, так как порты будут напрямую открыты на хосте.

#### Настройка PostgreSQL

Конфигурация PostgreSQL по умолчанию использует:
- **Пользователь**: `xui_user`
- **База данных**: `xui_db`
- **Порт**: `5432` (открыт для внешнего доступа при необходимости)

Чтобы изменить эти настройки, обновите переменные окружения в `docker-compose.yml`.

#### Настройка Redis

Redis автоматически настроен и интегрирован. Дополнительная настройка не требуется.

#### Настройка через переменные окружения

SharX поддерживает комплексную настройку через переменные окружения. Эти настройки **доступны только через переменные окружения** и не могут быть изменены через веб-интерфейс.

**Настройки веб-панели:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `XUI_WEB_PORT` | Порт веб-панели | `2053` | `2053` |
| `XUI_WEB_LISTEN` | IP адрес для прослушивания | - | `0.0.0.0` |
| `XUI_WEB_DOMAIN` | Домен веб-панели | - | `panel.example.com` |
| `XUI_WEB_BASE_PATH` | Базовый путь URL | `/` | `/` |
| `XUI_WEB_CERT_FILE` | Путь к SSL сертификату | - | `/app/cert/fullchain.pem` |
| `XUI_WEB_KEY_FILE` | Путь к приватному ключу | - | `/app/cert/privkey.pem` |

**Настройки сервиса подписки:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `XUI_SUB_PORT` | Порт сервиса подписки | `2096` | `2096` |
| `XUI_SUB_PATH` | URI путь для подписки | `/sub/` | `/sub/` |
| `XUI_SUB_DOMAIN` | Домен для подписки | - | `sub.example.com` |
| `XUI_SUB_CERT_FILE` | Путь к SSL сертификату для подписки | - | `/app/cert/sub-fullchain.pem` |
| `XUI_SUB_KEY_FILE` | Путь к приватному ключу для подписки | - | `/app/cert/sub-privkey.pem` |

**Настройки базы данных PostgreSQL:**

| Переменная | Описание | По умолчанию | Обязательная | Пример |
|------------|----------|--------------|--------------|--------|
| `XUI_DB_HOST` | Хост PostgreSQL | `localhost` | Нет | `postgres` |
| `XUI_DB_PORT` | Порт PostgreSQL | `5432` | Нет | `5432` |
| `XUI_DB_USER` | Пользователь PostgreSQL | - | **Да** | `xui_user` |
| `XUI_DB_PASSWORD` | Пароль PostgreSQL | - | **Да** | `change_this_password` |
| `XUI_DB_NAME` | Имя базы данных | Имя приложения | Нет | `xui_db` |
| `XUI_DB_SSLMODE` | Режим SSL | `disable` | Нет | `disable`, `require`, `verify-ca`, `verify-full` |

**Логирование и отладка:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `XUI_LOG_LEVEL` | Уровень логирования | `info` | `debug`, `info`, `notice`, `warning`, `error` |
| `XUI_DEBUG` | Режим отладки | `false` | `true`, `false` |
| `XUI_LOG_FOLDER` | Папка для логов | Зависит от платформы | `/var/log/xui` |

**Настройки Xray:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `XRAY_VMESS_AEAD_FORCED` | Принудительное использование VMESS AEAD | `false` | `true`, `false` |

**Безопасность:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `XUI_ENABLE_FAIL2BAN` | Включить fail2ban | `true` | `true`, `false` |

**TLS настройки для узла:**

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `NODE_TLS_CERT_FILE` | Путь к SSL сертификату для API ноды | - | `/app/cert/node-cert.pem` |
| `NODE_TLS_KEY_FILE` | Путь к приватному ключу для API ноды | - | `/app/cert/node-key.pem` |

**Пример конфигурации docker-compose.yml:**

```yaml
services:
  3xui:
    environment:
      # Xray настройки
      XRAY_VMESS_AEAD_FORCED: "false"
      XUI_ENABLE_FAIL2BAN: "true"
      
      # Web Panel настройки (только через env, не доступны в UI)
      XUI_WEB_PORT: 2053
      XUI_WEB_LISTEN: 0.0.0.0
      XUI_WEB_DOMAIN: panel.example.com
      XUI_WEB_BASE_PATH: /
      XUI_WEB_CERT_FILE: /app/cert/fullchain.pem
      XUI_WEB_KEY_FILE: /app/cert/privkey.pem
      
      # Subscription настройки (только через env, не доступны в UI)
      XUI_SUB_PORT: 2096
      XUI_SUB_PATH: /sub/
      XUI_SUB_DOMAIN: sub.example.com
      XUI_SUB_CERT_FILE: /app/cert/sub-fullchain.pem
      XUI_SUB_KEY_FILE: /app/cert/sub-privkey.pem
      
      # PostgreSQL настройки
      XUI_DB_HOST: postgres
      XUI_DB_PORT: 5432
      XUI_DB_USER: xui_user
      XUI_DB_PASSWORD: change_this_password
      XUI_DB_NAME: xui_db
      XUI_DB_SSLMODE: disable
```

**Важные примечания:**
- Настройки Web Panel и Subscription (`XUI_WEB_*` и `XUI_SUB_*`) доступны **только через переменные окружения** и не могут быть изменены через веб-интерфейс
- Учетные данные базы данных (`XUI_DB_USER`, `XUI_DB_PASSWORD`) являются **обязательными** для работы приложения
- Все пути к сертификатам должны быть абсолютными путями внутри контейнера (обычно `/app/cert/*.pem`)
- База данных хранится на хосте через bind mount: `$PWD/postgres_data:/var/lib/postgresql/data`

#### SSL-сертификаты и настройка TLS

**Настройка сертификатов:**

1. **Получите SSL-сертификаты**
   - Вам необходимо доменное имя, указывающее на ваш сервер
   - Получите SSL-сертификаты (например, от Let's Encrypt, или используйте свой CA)
   - Вам понадобятся два файла:
     - **Для панели**: Файл сертификата: `cert.pem` (или `fullchain.pem`)
     - **Для узлов** (рекомендуется): Файл сертификата: `fullchain.pem`
     - Файл приватного ключа: `privkey.pem` (для панели и узлов)

2. **Поместите сертификаты в директорию cert/**
   ```bash
   # Убедитесь, что директория cert существует
   mkdir -p cert
   
   # Скопируйте файлы сертификатов
   cp /путь/к/сертификату.pem cert/cert.pem
   cp /путь/к/приватному_ключу.key cert/privkey.pem
   
   # Установите правильные права доступа
   chmod 644 cert/cert.pem
   chmod 600 cert/privkey.pem
   ```

3. **Настройте в панели**
   - Доменное имя: Ваш домен (например, `panel.example.com`)
   - Путь к сертификату: `/app/cert/cert.pem`
   - Путь к приватному ключу: `/app/cert/privkey.pem`

**Для узлов:**
- **Рекомендуемый формат сертификата**: Используйте `fullchain.pem` для узлов
- Файл сертификата: `fullchain.pem`
- Файл приватного ключа: `privkey.pem`
- Эти файлы должны находиться в директории `node/cert/`
- Переменные окружения в `docker-compose.yml` узла:
  - `NODE_TLS_CERT_FILE=/app/cert/fullchain.pem`
  - `NODE_TLS_KEY_FILE=/app/cert/privkey.pem`

**Соответствие путей сертификатов:**
- Путь на хосте: `./cert/` (относительно docker-compose.yml)
- Монтирование в контейнере: `/root/cert/` (как определено в volumes)
- Пути в панели: `/app/cert/` (используются в настройках панели)

**Проверка TLS:**
- После настройки откройте панель через `https://ваш-домен.com:2053`
- Браузер должен показывать валидный SSL-сертификат
- Проверяйте срок действия сертификата и обновляйте при необходимости

### Миграция с SQLite

Если вы мигрируете со старой версии, использующей SQLite (версия 2.8.5 и выше):

1. **Экспортируйте данные из старой панели**
   - Экспортируйте вашу конфигурацию из старой панели (версия 2.8.5 или выше)
   - Сохраните файл резервной копии в безопасном месте
   - Этот файл резервной копии будет использован для миграции

2. **Запустите новую панель**
   - Следуйте шагам установки выше для настройки новой панели
   - Откройте веб-интерфейс новой панели
   - Пройдите начальную настройку, если требуется

3. **Важно: Предупреждение о настройке домена**
   
   **⚠️ Критично**: Если на вашей старой панели был настроен другой домен, он перезапишет настройки домена в новой панели во время миграции.
   
   **Перед импортом**, если вам нужно сохранить настройки домена новой панели:
   - Подключитесь к базе данных SQLite
   - Очистите настройки домена от данных старой панели в базе данных
   - Это предотвратит перезапись настроек домена новой панели старым доменом
   
   **Примечание**: Ваши учетные данные для входа (логин и пароль) останутся неизменными после миграции.

4. **Импортируйте ваши данные**
   - Перейдите в меню **Настройки** в новой панели
   - Найдите опцию миграции/импорта
   - Загрузите файл резервной копии из старой панели (версия 2.8.5+)
   - Миграция будет обработана автоматически
   - Убедитесь, что все данные были успешно перенесены
   - Проверьте, что настройки домена корректны (если вы не очистили их из старых данных)

### Решение проблем

#### Проверка статуса контейнеров
```bash
docker-compose ps
```

#### Просмотр логов
```bash
docker-compose logs -f
```

#### Перезапуск сервисов
```bash
docker-compose restart
```

#### Остановка сервисов
```bash
docker-compose down
```

#### Удаление всех данных (⚠️ Внимание: Это удалит все данные)
```bash
docker-compose down -v
```

### Документация API

Для программной интеграции с панелью SharX смотрите полный справочник API:

- **[Документация API](docs/API.md)** - REST API эндпоинты, аутентификация, примеры

### Поддержка

По вопросам, проблемам или вкладу в проект обращайтесь в репозиторий проекта.

---

**Примечание**: Эта версия использует Docker-контейнеры для легкого развертывания и управления. Все образы предварительно собраны и готовы к использованию, что устраняет необходимость компиляции или сложных процедур настройки.
